name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-checks:
    name: PR Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better diffs

      - name: Check PR title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "PR Title: $PR_TITLE"

          # Check for conventional commit style (optional)
          if [[ ! "$PR_TITLE" =~ ^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: ]]; then
            echo "⚠️ PR title doesn't follow conventional commit style"
            echo "Consider using: feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert: description"
          fi

      - name: Check for CHANGELOG update
        run: |
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "CHANGELOG.md"; then
            echo "✅ CHANGELOG.md updated"
          else
            echo "⚠️ Consider updating CHANGELOG.md"
          fi
        continue-on-error: true

      - name: Label PR based on changes
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Check for breaking changes
        run: |
          if git log origin/${{ github.base_ref }}..HEAD --format=%B | grep -i "BREAKING CHANGE"; then
            echo "⚠️ **BREAKING CHANGE detected**" >> $GITHUB_STEP_SUMMARY
            echo "This PR contains breaking changes. Please ensure:" >> $GITHUB_STEP_SUMMARY
            echo "1. Documentation is updated" >> $GITHUB_STEP_SUMMARY
            echo "2. Migration guide is provided" >> $GITHUB_STEP_SUMMARY
            echo "3. Version is bumped appropriately" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('PR Checklist')
            );

            const body = `## PR Checklist

            Thank you for your contribution! Please ensure:

            - [ ] Tests pass locally
            - [ ] Code follows project style guidelines
            - [ ] Documentation is updated (if needed)
            - [ ] No sensitive data or secrets committed
            - [ ] CHANGELOG.md updated (for user-facing changes)

            The CI pipeline will run automatically and check:
            ✅ Backend tests
            ✅ Frontend build
            ✅ Code linting
            ✅ SAM template validation
            `;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  size-check:
    name: Check PR Size
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR size
        run: |
          FILES_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          LINES_CHANGED=$(git diff --shortstat origin/${{ github.base_ref }}...HEAD | grep -oE '[0-9]+ insertion|[0-9]+ deletion' | awk '{sum+=$1} END {print sum}')

          echo "Files changed: $FILES_CHANGED"
          echo "Lines changed: $LINES_CHANGED"

          echo "### PR Size Analysis" >> $GITHUB_STEP_SUMMARY
          echo "- **Files changed**: $FILES_CHANGED" >> $GITHUB_STEP_SUMMARY
          echo "- **Lines changed**: $LINES_CHANGED" >> $GITHUB_STEP_SUMMARY

          if [ "$LINES_CHANGED" -gt 500 ]; then
            echo "⚠️ **Large PR detected** ($LINES_CHANGED lines changed)" >> $GITHUB_STEP_SUMMARY
            echo "Consider breaking this into smaller PRs for easier review" >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ **Good PR size**" >> $GITHUB_STEP_SUMMARY
          fi

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
        continue-on-error: true
